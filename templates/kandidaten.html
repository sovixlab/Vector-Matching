{% extends 'base.html' %}

{% block title %}Kandidaten - Vector Matching{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-base-content">Kandidaten</h1>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} mb-2">
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Upload Dropzone -->
    <div class="card bg-base-200 shadow-xl mb-8">
        <div class="card-body">
            <h2 class="card-title text-base-content mb-4">CV Upload</h2>
            
            <!-- Dropzone -->
            <div id="dropzone" class="border-2 border-dashed border-base-content/20 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer">
                <div class="flex flex-col items-center">
                    <svg class="w-12 h-12 text-base-content/40 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="text-base-content/60 mb-2">
                        Sleep PDF bestanden hierheen of klik om te selecteren
                    </p>
                    <p class="text-sm text-base-content/40">
                        Maximaal 100 PDF bestanden tegelijk
                    </p>
                </div>
            </div>

            
        </div>
    </div>

    <!-- Kandidaten Tabel -->
    <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title text-base-content">Kandidaten overzicht ({{ total_count }})</h2>
                <div class="flex gap-2">
                    <button id="select-all-btn" class="btn btn-sm btn-outline">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Alles selecteren
                    </button>
                    <button id="bulk-delete-btn" class="btn btn-sm btn-error" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span id="selected-count">0</span> verwijderen
                    </button>
                </div>
            </div>
            
            {% if candidates %}
                <form id="bulk-delete-form" method="post" action="{% url 'vector_matching_app:kandidaten_bulk_delete' %}">
                    {% csrf_token %}
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th class="text-base-content">
                                        <input type="checkbox" id="select-all-checkbox" class="checkbox checkbox-sm">
                                    </th>
                                    <th class="text-base-content">Naam</th>
                                    <th class="text-base-content">E-mailadres</th>
                                    <th class="text-base-content">Opleidingsniveau</th>
                                    <th class="text-base-content">Jaren ervaring</th>
                                    <th class="text-base-content">Locatie</th>
                                    <th class="text-base-content">Embedding status</th>
                                    <th class="text-base-content">Acties</th>
                                </tr>
                            </thead>
                        <tbody>
                            {% for candidate in candidates %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="candidate_ids" value="{{ candidate.id }}" 
                                           class="candidate-checkbox checkbox checkbox-sm">
                                </td>
                                <td class="text-base-content">
                                    <div class="font-medium">{{ candidate.name|default:"Niet opgegeven" }}</div>
                                </td>
                                <td class="text-base-content/70">
                                    {{ candidate.email|default:"Niet opgegeven" }}
                                </td>
                                <td class="text-base-content/70">
                                    {{ candidate.education_level|default:"Niet opgegeven" }}
                                </td>
                                <td class="text-base-content/70">
                                    {% if candidate.years_experience %}
                                        {{ candidate.years_experience }} jaar
                                    {% else %}
                                        Niet opgegeven
                                    {% endif %}
                                </td>
                                <td class="text-base-content/70">
                                    {{ candidate.city|default:"Niet opgegeven" }}
                                </td>
                                <td>
                                    {% if candidate.embed_status == 'completed' %}
                                        <div class="text-green-500 text-xl">✓</div>
                                    {% elif candidate.embed_status == 'failed' %}
                                        <div class="text-red-500 text-xl">✗</div>
                                    {% else %}
                                        <div class="text-yellow-500 text-xl">⏳</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex gap-2">
                                        <a href="{% url 'vector_matching_app:kandidaat_detail' candidate.id %}" 
                                           class="btn btn-sm btn-outline btn-primary">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </a>
                                        
                                        <a href="{% url 'vector_matching_app:kandidaat_edit' candidate.id %}" 
                                           class="btn btn-sm btn-outline btn-warning">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-8">
                    <svg class="w-16 h-16 text-base-content/20 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-base-content/60 mb-2">Geen kandidaten gevonden</h3>
                    <p class="text-base-content/40">Sleep PDF bestanden naar de upload zone hierboven om te beginnen!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

<!-- Upload Form (hidden) -->
<form id="upload-form" action="{% url 'vector_matching_app:kandidaten_upload' %}" method="post" enctype="multipart/form-data" style="position: absolute; left: -9999px; top: -9999px; visibility: hidden;">
    {% csrf_token %}
    <input type="file" id="upload-files" name="files" multiple accept=".pdf" style="position: absolute; left: -9999px; top: -9999px; visibility: hidden;">
</form>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript geladen');
    
    const dropzone = document.getElementById('dropzone');
    const uploadForm = document.getElementById('upload-form');
    const uploadFiles = document.getElementById('upload-files');
    const uploadProgress = document.getElementById('upload-progress');
    
    console.log('Elementen gevonden:', {
        dropzone: !!dropzone,
        uploadForm: !!uploadForm,
        uploadFiles: !!uploadFiles,
        uploadProgress: !!uploadProgress
    });

    // Click to select files
    if (dropzone && uploadFiles) {
        dropzone.addEventListener('click', () => {
            console.log('Dropzone geklikt');
            uploadFiles.click();
        });

        // File input change
        uploadFiles.addEventListener('change', handleFiles);

        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-primary', 'bg-primary/5');
        });

        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-primary', 'bg-primary/5');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-primary', 'bg-primary/5');
            
            const files = e.dataTransfer.files;
            console.log('Bestanden gedropt:', files.length);
            handleFileList(files);
        });
    } else {
        console.error('Dropzone of uploadFiles element niet gevonden!');
    }

    function handleFiles(e) {
        const files = e.target.files;
        handleFileList(files);
    }

    // Bulk delete functionality
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const selectAllBtn = document.getElementById('select-all-btn');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    const candidateCheckboxes = document.querySelectorAll('.candidate-checkbox');
    const bulkDeleteForm = document.getElementById('bulk-delete-form');

    // Select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        candidateCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkDeleteButton();
    });

    // Individual checkboxes
    candidateCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkDeleteButton);
    });

    // Select all button
    selectAllBtn.addEventListener('click', function() {
        const allChecked = Array.from(candidateCheckboxes).every(cb => cb.checked);
        candidateCheckboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });
        selectAllCheckbox.checked = !allChecked;
        updateBulkDeleteButton();
    });

    // Bulk delete button
    bulkDeleteBtn.addEventListener('click', function() {
        const selectedCount = document.querySelectorAll('.candidate-checkbox:checked').length;
        if (selectedCount > 0) {
            if (confirm(`Weet je zeker dat je ${selectedCount} kandidaat(en) wilt verwijderen?`)) {
                bulkDeleteForm.submit();
            }
        }
    });

    function updateBulkDeleteButton() {
        const selectedCount = document.querySelectorAll('.candidate-checkbox:checked').length;
        selectedCountSpan.textContent = selectedCount;
        bulkDeleteBtn.disabled = selectedCount === 0;
        
        // Update select all checkbox state
        if (selectedCount === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (selectedCount === candidateCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }

    function handleFileList(files) {
        console.log('handleFileList aangeroepen met', files.length, 'bestanden');
        
        // Validatie
        if (files.length === 0) {
            console.log('Geen bestanden geselecteerd');
            return;
        }
        
        if (files.length > 100) {
            alert('Maximaal 100 bestanden tegelijk toegestaan.');
            return;
        }

        // Controleer bestandstypen
        const invalidFiles = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                invalidFiles.push(file.name);
            }
        }

        if (invalidFiles.length > 0) {
            alert(`Alleen PDF bestanden zijn toegestaan. Ongeldige bestanden: ${invalidFiles.join(', ')}`);
            return;
        }

        console.log('Bestanden gevalideerd, start upload');
        
        // Zet de files in de input en submit
        uploadFiles.files = files;
        uploadForm.submit();
    }
    
});
</script>
{% endblock %}
