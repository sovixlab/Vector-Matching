{% extends 'base.html' %}

{% block title %}Kandidaten - Vector Matching{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-base-content">Kandidaten</h1>
    </div>

    <!-- UPLOAD DROPZONE -->
    <div class="mb-8">
        <div id="upload-dropzone" class="border-2 border-dashed border-primary rounded-lg p-8 text-center bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
            <div class="flex flex-col items-center">
                <svg class="w-12 h-12 text-primary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h3 class="text-lg font-medium text-base-content mb-2">Sleep PDF bestanden hierheen</h3>
                <p class="text-base-content/60 mb-4">of klik om bestanden te selecteren</p>
                <input type="file" id="upload-files" multiple accept=".pdf" class="hidden">
            </div>
        </div>
        
        <!-- UPLOAD PROGRESS -->
        <div id="upload-progress" class="hidden mt-4">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-base-content mb-4">
                        <div class="loading loading-spinner loading-sm text-primary"></div>
                        Uploaden en verwerken...
                    </h3>
                    
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-base-content/60 mb-2">
                            <span id="progress-text">0 van 0 bestanden verwerkt</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <progress id="progress-bar" class="progress progress-primary w-full" value="0" max="100"></progress>
                    </div>
                    
                    <!-- Results -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Toegevoegd -->
                        <div class="bg-success/10 border border-success/20 rounded-lg p-3">
                            <h4 class="font-medium text-success mb-2">✅ Toegevoegd</h4>
                            <div id="added-list" class="text-sm text-success/80 space-y-1">
                                <p class="text-base-content/40">Geen bestanden toegevoegd</p>
                            </div>
                        </div>
                        
                        <!-- Overgeslagen -->
                        <div class="bg-warning/10 border border-warning/20 rounded-lg p-3">
                            <h4 class="font-medium text-warning mb-2">⏭️ Overgeslagen</h4>
                            <div id="skipped-list" class="text-sm text-warning/80 space-y-1">
                                <p class="text-base-content/40">Geen duplicaten gevonden</p>
                            </div>
                        </div>
                        
                        <!-- Mislukt -->
                        <div class="bg-error/10 border border-error/20 rounded-lg p-3">
                            <h4 class="font-medium text-error mb-2">❌ Mislukt</h4>
                            <div id="failed-list" class="text-sm text-error/80 space-y-1">
                                <p class="text-base-content/40">Geen fouten opgetreden</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- BULK REPROCESS PROGRESS -->
    <div id="bulk-reprocess-progress" class="hidden mb-8">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-base-content mb-4">
                    <div class="loading loading-spinner loading-sm text-info"></div>
                    Bulk opnieuw embedden...
                </h3>
                
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-base-content/60 mb-2">
                        <span id="bulk-progress-text">0 van 0 kandidaten verwerkt</span>
                        <span id="bulk-progress-percentage">0%</span>
                    </div>
                    <progress id="bulk-progress-bar" class="progress progress-info w-full" value="0" max="100"></progress>
                </div>
                
                <!-- Results -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Succesvol -->
                    <div class="bg-success/10 border border-success/20 rounded-lg p-3">
                        <h4 class="font-medium text-success mb-2">✅ Succesvol</h4>
                        <div id="bulk-success-list" class="text-sm text-success/80 space-y-1">
                            <p class="text-base-content/40">Geen kandidaten verwerkt</p>
                        </div>
                    </div>
                    
                    <!-- Overgeslagen -->
                    <div class="bg-warning/10 border border-warning/20 rounded-lg p-3">
                        <h4 class="font-medium text-warning mb-2">⏭️ Overgeslagen</h4>
                        <div id="bulk-skipped-list" class="text-sm text-warning/80 space-y-1">
                            <p class="text-base-content/40">Geen kandidaten overgeslagen</p>
                        </div>
                    </div>
                    
                    <!-- Mislukt -->
                    <div class="bg-error/10 border border-error/20 rounded-lg p-3">
                        <h4 class="font-medium text-error mb-2">❌ Mislukt</h4>
                        <div id="bulk-failed-list" class="text-sm text-error/80 space-y-1">
                            <p class="text-base-content/40">Geen fouten opgetreden</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} mb-2">
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        </div>
    {% endif %}


    <!-- Kandidaten Tabel -->
    <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title text-base-content">Kandidaten overzicht ({{ total_count }})</h2>
                <div class="flex gap-2">
                    <button id="select-all-btn" class="btn btn-sm btn-outline">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Alles selecteren
                    </button>
                    <button id="bulk-reprocess-btn" class="btn btn-sm btn-info" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span id="selected-count">0</span> opnieuw embedden
                    </button>
                    <button id="bulk-delete-btn" class="btn btn-sm btn-error" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span id="selected-count-delete">0</span> verwijderen
                    </button>
                </div>
            </div>
            
            {% if candidates %}
                <form id="bulk-reprocess-form" method="post" action="{% url 'vector_matching_app:kandidaten_bulk_reprocess' %}">
                    {% csrf_token %}
                </form>
                <form id="bulk-delete-form" method="post" action="{% url 'vector_matching_app:kandidaten_bulk_delete' %}">
                    {% csrf_token %}
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th class="text-base-content">
                                        <input type="checkbox" id="select-all-checkbox" class="checkbox checkbox-sm">
                                    </th>
                                    <th class="text-base-content">Naam</th>
                                    <th class="text-base-content">E-mailadres</th>
                                    <th class="text-base-content">Opleidingsniveau</th>
                                    <th class="text-base-content">Jaren ervaring</th>
                                    <th class="text-base-content">Locatie</th>
                                    <th class="text-base-content">Embedding status</th>
                                    <th class="text-base-content">Acties</th>
                                </tr>
                            </thead>
                        <tbody>
                            {% for candidate in candidates %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="candidate_ids" value="{{ candidate.id }}" 
                                           class="candidate-checkbox checkbox checkbox-sm">
                                </td>
                                <td class="text-base-content">
                                    <div class="font-medium">{{ candidate.name|default:"Niet opgegeven" }}</div>
                                </td>
                                <td class="text-base-content/70">
                                    {{ candidate.email|default:"Niet opgegeven" }}
                                </td>
                                <td class="text-base-content/70">
                                    {{ candidate.education_level|default:"Niet opgegeven" }}
                                </td>
                                <td class="text-base-content/70">
                                    {% if candidate.years_experience %}
                                        {{ candidate.years_experience }} jaar
                                    {% else %}
                                        Niet opgegeven
                                    {% endif %}
                                </td>
                                <td class="text-base-content/70">
                                    {{ candidate.city|default:"Niet opgegeven" }}
                                </td>
                                <td>
                                    {% if candidate.embed_status == 'completed' %}
                                        <div class="text-green-500 text-xl">✓</div>
                                    {% elif candidate.embed_status == 'failed' %}
                                        <div class="text-red-500 text-xl">✗</div>
                                    {% else %}
                                        <div class="text-yellow-500 text-xl">⏳</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex gap-2">
                                        <a href="{% url 'vector_matching_app:kandidaat_detail' candidate.id %}" 
                                           class="btn btn-sm btn-outline btn-primary">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </a>
                                        
                                        <a href="{% url 'vector_matching_app:kandidaat_edit' candidate.id %}" 
                                           class="btn btn-sm btn-outline btn-warning">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-8">
                    <svg class="w-16 h-16 text-base-content/20 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-base-content/60 mb-2">Geen kandidaten gevonden</h3>
                    <p class="text-base-content/40">Sleep PDF bestanden naar de upload zone hierboven om te beginnen!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
// CSRF token direct beschikbaar maken
window.csrfToken = '{{ csrf_token|escapejs }}';

document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript geladen');
    
    // Debug CSRF token
    console.log('CSRF token:', window.csrfToken ? window.csrfToken.substring(0, 10) + '...' : 'NIET GEVONDEN');
    
    // Fallback CSRF token zoeken
    if (!window.csrfToken) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            window.csrfToken = csrfInput.value;
            console.log('CSRF token gevonden via fallback:', window.csrfToken.substring(0, 10) + '...');
        } else {
            console.error('CSRF token helemaal niet gevonden!');
        }
    }
    
    // DROPZONE - EENVOUDIGE VERSIE
    const dropzone = document.getElementById('upload-dropzone');
    const uploadFiles = document.getElementById('upload-files');
    
    if (dropzone && uploadFiles) {
        console.log('Dropzone gevonden!');
        
        // Click to select files
        dropzone.addEventListener('click', () => {
            console.log('Dropzone geklikt');
            uploadFiles.click();
        });
        
        // File input change
        uploadFiles.addEventListener('change', (e) => {
            console.log('Bestanden geselecteerd:', e.target.files.length);
            handleFiles(e.target.files);
        });
        
        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-accent', 'bg-accent/10');
        });
        
        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-accent', 'bg-accent/10');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-accent', 'bg-accent/10');
            
            const files = e.dataTransfer.files;
            console.log('Bestanden gedropt:', files.length);
            handleFiles(files);
        });
    }
    

    // UPLOAD FUNCTIE MET ECHTE PROGRESS
    function handleFiles(files) {
        console.log('Upload: handleFiles aangeroepen met', files.length, 'bestanden');
        
        if (!files || files.length === 0) {
            console.log('Geen bestanden geselecteerd');
            return;
        }
        
        // Valideer bestanden
        const validFiles = [];
        const invalidFiles = [];
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type === 'application/pdf') {
                validFiles.push(file);
            } else {
                invalidFiles.push(file.name);
                console.warn('Bestand niet ondersteund:', file.name, file.type);
            }
        }
        
        if (validFiles.length === 0) {
            alert('Geen geldige PDF bestanden gevonden!');
            return;
        }
        
        // Waarschuwing voor grote uploads
        if (validFiles.length > 50) {
            const proceed = confirm(`Je probeert ${validFiles.length} bestanden te uploaden. Dit kan enige tijd duren. Wil je doorgaan?`);
            if (!proceed) {
                return;
            }
        }
        
        // Toon progress UI
        showProgressUI(validFiles.length);
        
        // Start upload
        uploadFilesSequentially(validFiles, 0, [], [], []);
    }
    
    function showProgressUI(totalFiles) {
        const progressDiv = document.getElementById('upload-progress');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        
        if (!progressDiv) {
            console.error('Upload progress div not found!');
            return;
        }
        
        progressDiv.classList.remove('hidden');
        
        if (progressText) {
            progressText.textContent = `0 van ${totalFiles} bestanden verwerkt`;
        }
        
        if (progressBar) {
            progressBar.value = 0;
            progressBar.max = totalFiles;
        }
        
        if (progressPercentage) {
            progressPercentage.textContent = '0%';
        }
        
        // Reset resultaten
        const addedList = document.getElementById('added-list');
        const skippedList = document.getElementById('skipped-list');
        const failedList = document.getElementById('failed-list');
        
        if (addedList) {
            addedList.innerHTML = '<p class="text-base-content/40">Geen bestanden toegevoegd</p>';
        }
        if (skippedList) {
            skippedList.innerHTML = '<p class="text-base-content/40">Geen duplicaten gevonden</p>';
        }
        if (failedList) {
            failedList.innerHTML = '<p class="text-base-content/40">Geen fouten opgetreden</p>';
        }
    }
    
    function updateProgress(current, total, added, skipped, failed) {
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        
        const percentage = Math.round((current / total) * 100);
        
        if (progressText) {
            progressText.textContent = `${current} van ${total} bestanden verwerkt`;
        }
        
        if (progressBar) {
            progressBar.value = current;
        }
        
        if (progressPercentage) {
            progressPercentage.textContent = `${percentage}%`;
        }
        
        // Update resultaten
        updateResultList('added-list', added, 'Geen bestanden toegevoegd');
        updateResultList('skipped-list', skipped, 'Geen duplicaten gevonden');
        updateResultList('failed-list', failed, 'Geen fouten opgetreden');
    }
    
    function updateResultList(listId, items, emptyText) {
        const listDiv = document.getElementById(listId);
        if (!listDiv) {
            console.error(`Result list ${listId} not found!`);
            return;
        }
        
        if (items.length === 0) {
            listDiv.innerHTML = `<p class="text-base-content/40">${emptyText}</p>`;
        } else {
            listDiv.innerHTML = items.map(item => `<p>• ${item}</p>`).join('');
        }
    }
    

    function uploadFilesSequentially(files, index, added, skipped, failed) {
        if (index >= files.length) {
            // Alle bestanden verwerkt
            console.log('Upload voltooid:', { added, skipped, failed });
            
            // Update naar 100%
            updateProgress(files.length, files.length, added, skipped, failed);
            
            // Toon eindresultaat
            setTimeout(() => {
                if (added.length > 0 || skipped.length > 0 || failed.length > 0) {
                    // Reload pagina om nieuwe kandidaten te tonen
                    window.location.reload();
                }
            }, 2000);
            return;
        }
        
        const file = files[index];
        console.log(`Uploading file ${index + 1}/${files.length}:`, file.name);
        
        // Maak FormData voor dit bestand
        const formData = new FormData();
        formData.append('files', file);
        
        // Voeg CSRF token toe
        const csrfToken = window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            console.error('CSRF token niet gevonden!');
            failed.push(`${file.name}: CSRF token niet gevonden`);
            updateProgress(index + 1, files.length, added, skipped, failed);
            setTimeout(() => {
                uploadFilesSequentially(files, index + 1, added, skipped, failed);
            }, 500);
            return;
        }
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Upload dit bestand
        fetch('{% url "vector_matching_app:kandidaten_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log(`Upload response voor ${file.name}:`, response.status);
            if (response.ok) {
                return response.json();
            } else {
                throw new Error(`Upload failed: ${response.status}`);
            }
        })
        .then(data => {
            console.log(`Upload succesvol voor ${file.name}:`, data);
            
            // Verwerk resultaat
            if (data.success) {
                if (data.created_candidates && data.created_candidates.length > 0) {
                    added.push(...data.created_candidates);
                }
                if (data.skipped_duplicates && data.skipped_duplicates.length > 0) {
                    skipped.push(...data.skipped_duplicates);
                }
                if (data.processing_errors && data.processing_errors.length > 0) {
                    failed.push(...data.processing_errors);
                }
            } else {
                failed.push(`${file.name}: ${data.error || 'Onbekende fout'}`);
            }
            
            // Update progress
            updateProgress(index + 1, files.length, added, skipped, failed);
            
            // Ga door naar volgende bestand
            setTimeout(() => {
                uploadFilesSequentially(files, index + 1, added, skipped, failed);
            }, 500); // 500ms delay tussen bestanden
        })
        .catch(error => {
            console.error(`Upload error voor ${file.name}:`, error);
            failed.push(`${file.name}: ${error.message}`);
            updateProgress(index + 1, files.length, added, skipped, failed);
            
            // Ga door naar volgende bestand
            setTimeout(() => {
                uploadFilesSequentially(files, index + 1, added, skipped, failed);
            }, 500);
        });
    }

    // Bulk actions functionality
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const selectAllBtn = document.getElementById('select-all-btn');
    const bulkReprocessBtn = document.getElementById('bulk-reprocess-btn');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    const selectedCountDeleteSpan = document.getElementById('selected-count-delete');
    const candidateCheckboxes = document.querySelectorAll('.candidate-checkbox');
    const bulkReprocessForm = document.getElementById('bulk-reprocess-form');
    const bulkDeleteForm = document.getElementById('bulk-delete-form');

    // Select all checkbox
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            candidateCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkButtons();
        });
    } else {
        console.error('Select all checkbox not found!');
    }

    // Individual checkboxes
    candidateCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkButtons);
    });

    // Select all button
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            const allChecked = Array.from(candidateCheckboxes).every(cb => cb.checked);
            candidateCheckboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = !allChecked;
            }
            updateBulkButtons();
        });
    } else {
        console.error('Select all button not found!');
    }

    // Bulk reprocess button
    if (bulkReprocessBtn) {
        bulkReprocessBtn.addEventListener('click', function() {
            const selectedCheckboxes = document.querySelectorAll('.candidate-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            if (selectedCount > 0) {
                if (confirm(`Weet je zeker dat je ${selectedCount} kandidaat(en) opnieuw wilt embedden? Dit kan even duren.`)) {
                    startBulkReprocess(selectedCheckboxes);
                }
            }
        });
    } else {
        console.error('Bulk reprocess button not found!');
    }

    if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', function() {
            const selectedCount = document.querySelectorAll('.candidate-checkbox:checked').length;
            if (selectedCount > 0) {
                if (confirm(`Weet je zeker dat je ${selectedCount} kandidaat(en) wilt verwijderen?`)) {
                    bulkDeleteForm.submit();
                }
            }
        });
    } else {
        console.error('Bulk delete button not found!');
    }

    function updateBulkButtons() {
        const selectedCount = document.querySelectorAll('.candidate-checkbox:checked').length;
        if (selectedCountSpan) {
            selectedCountSpan.textContent = selectedCount;
        }
        if (selectedCountDeleteSpan) {
            selectedCountDeleteSpan.textContent = selectedCount;
        }
        if (bulkReprocessBtn) {
            bulkReprocessBtn.disabled = selectedCount === 0;
        }
        if (bulkDeleteBtn) {
            bulkDeleteBtn.disabled = selectedCount === 0;
        }
        
        // Update select all checkbox state
        if (selectAllCheckbox) {
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === candidateCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
    }

    // Bulk reprocess functions
    function startBulkReprocess(selectedCheckboxes) {
        const candidateIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        const totalCount = candidateIds.length;
        
        // Show progress UI
        showBulkProgressUI(totalCount);
        
        // Process candidates one by one
        processBulkReprocess(candidateIds, 0, [], [], []);
    }
    
    function showBulkProgressUI(totalCandidates) {
        const progressDiv = document.getElementById('bulk-reprocess-progress');
        const progressText = document.getElementById('bulk-progress-text');
        const progressBar = document.getElementById('bulk-progress-bar');
        const progressPercentage = document.getElementById('bulk-progress-percentage');
        
        progressDiv.classList.remove('hidden');
        progressText.textContent = `0 van ${totalCandidates} kandidaten verwerkt`;
        progressBar.value = 0;
        progressBar.max = totalCandidates;
        progressPercentage.textContent = '0%';
        
        // Reset results
        document.getElementById('bulk-success-list').innerHTML = '<p class="text-base-content/40">Geen kandidaten verwerkt</p>';
        document.getElementById('bulk-skipped-list').innerHTML = '<p class="text-base-content/40">Geen kandidaten overgeslagen</p>';
        document.getElementById('bulk-failed-list').innerHTML = '<p class="text-base-content/40">Geen fouten opgetreden</p>';
    }
    
    function updateBulkProgress(current, total, success, skipped, failed) {
        const progressText = document.getElementById('bulk-progress-text');
        const progressBar = document.getElementById('bulk-progress-bar');
        const progressPercentage = document.getElementById('bulk-progress-percentage');
        
        const percentage = Math.round((current / total) * 100);
        progressText.textContent = `${current} van ${total} kandidaten verwerkt`;
        progressBar.value = current;
        progressPercentage.textContent = `${percentage}%`;
        
        // Update results
        updateBulkResultList('bulk-success-list', success, 'Geen kandidaten verwerkt');
        updateBulkResultList('bulk-skipped-list', skipped, 'Geen kandidaten overgeslagen');
        updateBulkResultList('bulk-failed-list', failed, 'Geen fouten opgetreden');
    }
    
    function updateBulkResultList(listId, items, emptyText) {
        const listDiv = document.getElementById(listId);
        if (items.length === 0) {
            listDiv.innerHTML = `<p class="text-base-content/40">${emptyText}</p>`;
        } else {
            listDiv.innerHTML = items.map(item => `<p>• ${item}</p>`).join('');
        }
    }
    
    function processBulkReprocess(candidateIds, index, success, skipped, failed) {
        if (index >= candidateIds.length) {
            // All candidates processed
            console.log('Bulk reprocess completed:', { success, skipped, failed });
            
            // Show final result and reload after delay
            setTimeout(() => {
                if (success.length > 0 || skipped.length > 0 || failed.length > 0) {
                    window.location.reload();
                }
            }, 3000);
            return;
        }
        
        const candidateId = candidateIds[index];
        console.log(`Processing candidate ${index + 1}/${candidateIds.length}: ${candidateId}`);
        
        // Make AJAX request for this candidate
        const formData = new FormData();
        formData.append('candidate_ids', candidateId);
        
        const csrfToken = window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            console.error('CSRF token niet gevonden voor bulk reprocess!');
            failed.push(`Kandidaat ${candidateId}: CSRF token niet gevonden`);
            updateBulkProgress(index + 1, candidateIds.length, success, skipped, failed);
            setTimeout(() => {
                processBulkReprocess(candidateIds, index + 1, success, skipped, failed);
            }, 1000);
            return;
        }
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch('{% url "vector_matching_app:kandidaten_bulk_reprocess" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log(`Response for candidate ${candidateId}:`, response.status);
            if (response.ok) {
                return response.text();
            } else {
                throw new Error(`Request failed: ${response.status}`);
            }
        })
        .then(data => {
            console.log(`Success for candidate ${candidateId}`);
            success.push(`Kandidaat ${candidateId}`);
            updateBulkProgress(index + 1, candidateIds.length, success, skipped, failed);
            
            // Continue to next candidate
            setTimeout(() => {
                processBulkReprocess(candidateIds, index + 1, success, skipped, failed);
            }, 1000); // 1 second delay between candidates
        })
        .catch(error => {
            console.error(`Error for candidate ${candidateId}:`, error);
            failed.push(`Kandidaat ${candidateId}: ${error.message}`);
            updateBulkProgress(index + 1, candidateIds.length, success, skipped, failed);
            
            // Continue to next candidate
            setTimeout(() => {
                processBulkReprocess(candidateIds, index + 1, success, skipped, failed);
            }, 1000);
        });
    }

    // Initialize buttons on page load
    updateBulkButtons();
    
});
</script>
{% endblock %}
